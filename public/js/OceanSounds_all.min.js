/// Ocean View Elements Manager 

var OceanViewManager = function( oDBMgr ) {
  console.log("* OceanViewManger Init *");
  if( !oDBMgr ) { 
    console.error("ERROR - OceanViewManager requires an OceanDatabaseManager() reference to initialize.  Exiting...");
    return;
  }
  this.oDBMgr = oDBMgr;

};

// View Drawing
OceanViewManager.prototype.drawLocationsStack = function() {
  var len = this.oDBMgr.getDatabaseLength();
  for(var i=0; i<len; i++) {
    this.insertLocationNavElement( i, "#locationInsertionPoint" );
  }
};

// View Templates
OceanViewManager.prototype.insertLocationNavElement = function( index, elementId ) {
  var audioDatabase = this.oDBMgr.getAudioDatabase();

  var locationName  = audioDatabase[index].locationName;
  var thumbImageURL = audioDatabase[index].thumb_image_URL;

  var locationHTML = '<div id="locBut' + index + '" class="liItem" style="background: #666 url( \'images/locations/' + thumbImageURL + '\' ) no-repeat center center;background-size: cover;"><image id="locAudioBut' + index + '" onclick="audioPlayerClicked(' + index + ')" class="buttonImage playButtonImage" width="80" height="80" alt=""></image><span>' + locationName + '</span></div>';

  $( locationHTML ).insertAfter( elementId );
};


;// http://demo.codesamplez.com/javascript/audio
// http://codesamplez.com/programming/control-html5-audio-with-jquery

console.log("audioController arrival.");

var audio;
function jInit(){
    audio = $("#audioPlayer");
    addEventHandlers();
}

function addEventHandlers(){
    $("a.load").click(loadAudio);
    $("a.start").click(startAudio);
    $("a.forward").click(forwardAudio);
    $("a.back").click(backAudio);
    $("a.pause").click(pauseAudio);
    $("a.stop").click(stopAudio);
    $("a.volume-up").click(volumeUp);
    $("a.volume-down").click(volumeDown);
    $("a.mute").click(toggleMuteAudio);

}

function loadAudio(){
    audio.bind("load",function(){ 
        var errmsg = "Sorry but there was an error: ";
        if ( status == "error" ) {
          alert( errmsg + xhr.status + " " + xhr.statusText );
        }
    });
    audio.trigger('load');
}

function startAudio(){
    audio.trigger('play');
}

function pauseAudio(){
    audio.trigger('pause');
}

function stopAudio(){
    pauseAudio();
    audio.prop("currentTime",0);
}

function forwardAudio(){
    pauseAudio();
    audio.prop("currentTime",audio.prop("currentTime")+5);
    startAudio();
}

function backAudio(){
    pauseAudio();
    audio.prop("currentTime",audio.prop("currentTime")-5);
    startAudio();
}

function volumeUp(){
    console.log("volumeUp!");
    var volume = audio.prop("volume")+0.2;
    if(volume >1){
        volume = 1;
    }
    audio.prop("volume",volume);
}

function volumeDown(){
    console.log("volumeDown!");
    var volume = audio.prop("volume")-0.2;
    if(volume <0){
        volume = 0;
    }
    audio.prop("volume",volume);
}

function toggleMuteAudio(){
    audio.prop("muted",!audio.prop("muted"));
};

var OceanDatabaseManager = function() {
  console.log("* OceanDatabaseManager Init *");
  this.AUDIOPATH = "audio\\ocean\\";
  this.audioDatabase = [
    { 
      "audioFilename": "164767__rucisko__ocean-waves_Coimbra_Portugal.mp3", 
      "locationName": "Figueria da Foz, Portugal", 
      "locationCountry": "Portugal",
      "thumb_image_URL": "Coimbra_Portugal_thumb.jpg",
      "rating": "5",
      "xpos": "20",
      "ypos": "63",
      "volumeAdj": 0
    },
    { 
      "audioFilename": "20140316-064528-Indonedia-SeaOfJava.mp3", 
      "locationName": "Indonesia, Java Sea", 
      "locationCountry": "Indonesia",
      "thumb_image_URL": "20140316-064528-Indonedia-SeaOfJava_thumb.jpg",
      "rating": "4",
      "xpos": "252",
      "ypos": "162",
      "volumeAdj": 0
    },
    { 
      "audioFilename": "166214__abcopen__southern-ocean__Warrnambool_Australia_Levys-Beach.mp3", 
      "locationName": "Levy's Beach, Warrnambool, Australia",
      "locationCountry": "Australia",
      "thumb_image_URL": "Levys-Beach_Warrnambool_Australia_thumb.jpg",
      "rating": "5",
      "xpos": "338",
      "ypos": "269",
      "volumeAdj": 0
    },
    { 
      "audioFilename": "frenchPolynesia.mp3", 
      "locationName": "French Polynesia", 
      "locationCountry": "French Polynesia",
      "thumb_image_URL": "fakarava_island_french_polynesia_thumb.jpg",
      "rating": "4",
      "xpos": "420",
      "ypos": "151",
      "volumeAdj": 0
    },
    { 
      "audioFilename": "OceanBeach-LandsEndwFogHorn.mp3", 
      "locationName": "Land's End, San Francisco CA, USA", 
      "locationCountry": "United States",
      "thumb_image_URL": "OceanBeach-LandsEndwFogHorn_thumb.jpg",
      "rating": "5",
      "xpos": "525",
      "ypos": "57",
      "volumeAdj": 0
    }
  ];


};

OceanDatabaseManager.prototype.getAudioData_audioFileNameWithPath = function(index)  {
  var obj = this.AUDIOPATH + this.audioDatabase[index].audioFilename; // getAudioDataObject(index);
  console.log("INDEX = " + index + " FILE: " + obj);
  return obj;
};

// for now, allow grabbing entire db object.
OceanDatabaseManager.prototype.getAudioDatabase = function(index)  {
  return this.audioDatabase;
};

OceanDatabaseManager.prototype.getAudioDataObject = function(index)  {
  if(index>=0 && index<this.audioDatabase.length) {
    return this.audioDatabase;
  }
  alert("ERROR - Invalid audio object id.");
};

OceanDatabaseManager.prototype.getAudioData_locationName = function(index)  {
  var obj = this.getAudioDataObject(index);
  return obj.locationName;
};

OceanDatabaseManager.prototype.getAudioData_rating = function(index)  {
  var obj = this.getAudioDataObject(index);
  return obj.rating;
};

OceanDatabaseManager.prototype.getAudioData_xpos = function(index)  {
  var obj = this.getAudioDataObject(index);
  return obj.xpos;
};

OceanDatabaseManager.prototype.getAudioData_ypos = function(index)  {
  var obj = this.getAudioDataObject(index);
  return obj.ypos;
};

OceanDatabaseManager.prototype.getDatabaseLength = function() {
  return this.audioDatabase.length;
};





;var currentSelection = 0;


var OceanInterfaceManager = function(oDBMgr, oViewMgr) {
  console.log("* OceanInterfaceManager Init *");
  if( !oDBMgr ) { 
    console.error("ERROR - OceanInterfaceManager requires an OceanDatabaseManager() reference to initialize.  Exiting...");
    return;
  }
  if( !oViewMgr ) { 
    console.error("ERROR - OceanInterfaceManager requires an OceanViewManager() reference to initialize.  Exiting...");
    return;
  }
  this.oDBMgr = oDBMgr;
  this.oViewMgr = oViewMgr;

  this.currentSelection = 0;
  this.lastSelection = -1;

  this.isFirstPlay = true;
  this.playButtonVisibilityState = this.setupPlayButtonVisibilityState();

  this.setupListeners();
};

OceanInterfaceManager.prototype.setupPlayButtonVisibilityState = function() {
  var len = this.oDBMgr.getDatabaseLength();
  var array = [];
  for(var i=0; i<len; i++) {
    array.push( true ); // Play button visible
  }
  return array;
};

OceanInterfaceManager.prototype.setupListeners = function() {
  $('#leftArrowButton').click(function(){    
    moveLeft();
  });
  $('#rightArrowButton').click(function(){    
    moveRight();
  });
  $('#muteButton').click(function(){
    muteToggle();
  });
  // Listen for arrow keys
  $(document).keydown(function(e) {
    switch(e.which) {
      case 37: // left
      console.log("left");
      moveLeft();
      break;

      case 38: // up
      console.log("volume up");
      muteToggle();
      break;

      case 39: // right
      console.log("right");
      moveRight();
      break;

      case 40: // down
      console.log("volume down");
      muteToggle();
      break;

      default: return; // exit this handler for other keys
    }
    // e.preventDefault(); // prevent the default action (scroll / move caret)
  });

  // Listen for Audio playback start
  document.getElementById('audioPlayer').addEventListener('playing',function() { 
    console.log("this.isPlaying is TRUE");
    this.isFirstPlay=false; 
    // this.playbackHasStarted();
  },false);
};

OceanInterfaceManager.prototype.playerClicked = function(index) {
  this.currentSelection = index;

  $('#nowPlayingMsg2').html(this.oDBMgr.audioDatabase[this.currentSelection].locationName);


  // Reset all PLAY/PAUSE button images
  for(var i=0; i<this.playButtonVisibilityState.length; i++) {
    document.getElementById('locAudioBut' + i).setAttribute('class', 'buttonImage playButtonImage');
  }

  // Current click handling
  if(this.currentSelection===this.lastSelection || this.isFirstPlay===true) {
    this.playButtonVisibilityState[this.currentSelection] = !(this.playButtonVisibilityState[this.currentSelection]);
  } 

  // Control Audio
  if(this.playButtonVisibilityState[this.currentSelection]) {
    pauseAudio();
    document.getElementById('locAudioBut' + this.currentSelection).setAttribute('class', 'buttonImage playButtonImage');
  } else {
    document.getElementById('audioPlayer').setAttribute('src', this.oDBMgr.getAudioData_audioFileNameWithPath(this.currentSelection) );
    loadAudio();
    document.getElementById('locAudioBut' + this.currentSelection).setAttribute('class', 'buttonImage pauseButtonImage');
  }

  this.lastSelection = this.currentSelection;
};





var audioPlayerClicked = function( index ) {
  oInterfaceMgr.playerClicked( index );
};


var moveLeft = function() {
  // console.log("moveLeft! currentSelection="+currentSelection);
  if ( currentSelection > 0 ) {
    currentSelection--;
  }
  drawPinsWithSelection( currentSelection );
};

var moveRight = function() {
  if ( currentSelection < len-1 ) {
    currentSelection++;
  }
  drawPinsWithSelection( currentSelection );
};

var muteToggle = function() {
  $('#muteButton').toggleClass("mutedMode");
  toggleMuteAudio();
};





// MAP FUNCTIONS

// var drawPinsWithSelection = function( selected ) {
//   console.log("drawPinsWithSelection - " + selected);

//   $('#leftArrowButton').removeClass("disabled");
//   $('#rightArrowButton').removeClass("disabled");

//   if(selected===0){
//     $('#leftArrowButton').addClass("disabled");
//   } else if(selected===audioDatabase.length-1) {
//     $('#rightArrowButton').addClass("disabled");
//   }


//   $("#pinId0").animate({
//       position: 'relative',
//       left: audioDatabase[selected].xpos + "px",
//       top: audioDatabase[selected].ypos + "px",
//       opacity: '1.00'
//     }, 1000, "swing", function() {
//         $( "#pinId0" ).html( "<div>" + audioDatabase[selected].locationCountry + "</div>" );
//     });

//   // var pin = document.getElementById('pinId0');
//   // pin.style.position = 'relative';
//   // pin.style.left = "" + audioDatabase[selected].xpos + "px";
//   // pin.style.top = "" + audioDatabase[selected].ypos + "px";
//   // // pin.src = '../images/pin3.png';

//    loadAudio()
// };





var oDatabaseMgr;
var oViewMgr;
var oInterfaceMgr;

// MAIN - ON.READY
$(document).ready(function (){
  jInit(); // Audio Player actions/listeners

  // Class Initialization (Psuedoclassical)
  oDatabaseMgr  = new OceanDatabaseManager();

  oViewMgr      = new OceanViewManager( oDatabaseMgr );
  oViewMgr.drawLocationsStack();

  oInterfaceMgr = new OceanInterfaceManager( oDatabaseMgr, oViewMgr );
  

  // drawPinsWithSelection( 0 );


});



